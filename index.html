<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TDM Indication Calculator</title>
  <!-- Tailwind CSS & Inter Font -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f7f9fb;
    }
    /* Custom Tailwind config for the toggle switch */
    .toggle-switch {
      transition: all 0.2s ease-in-out;
    }
    .toggle-switch:checked {
      @apply bg-green-500;
    }
    .toggle-switch:checked + .slider {
      transform: translateX(100%);
    }
    .slider {
      transition: transform 0.2s ease-in-out;
    }
    .input-field {
        border: none;
        border-radius: 0.5rem;
        padding: 0.75rem;
        text-align: right;
        font-weight: 700;
        color: #1e3a8a; /* Indigo-800 */
        transition: border-color 0.2s;
    }
    .input-group label {
        font-weight: 600;
        color: #4b5563; /* Gray-600 */
    }
    .toggle-switch-label {
        background-color: #e5e7eb; /* bg-gray-200 for unchecked state */
    }
    .toggle-switch-input:checked + .toggle-switch-label {
        background-color: #10b981; /* bg-green-500 for checked state */
    }
  </style>
</head>
<body class="p-4 sm:p-8">
  <div id="app" class="max-w-md mx-auto bg-white rounded-3xl shadow-2xl overflow-hidden">
    <!-- Header -->
    <header class="p-6 bg-indigo-700 text-white">
      <h1 class="text-2xl font-extrabold text-center">Epilepsy EZ Check</h1>
      <p class="text-sm text-center mt-1 opacity-80">
        TDM Indication Score Calculator 
                  JKWPKL&P
      </p>
    </header>

    <!-- Prerequisite Alert -->
    <div class="p-4 bg-red-50 text-red-800 border-b border-red-200">
      <p class="font-bold text-sm">Prerequisite:</p>
      <p class="text-xs italic">
        Patient has had **breakthrough seizures** in the past six months.
      </p>
    </div>

    <!-- Inputs & Toggles Section -->
    <main class="p-6 space-y-6">
      <!-- 1. Demographic Inputs & BMI Calculation -->
      <h2 class="text-lg font-bold text-indigo-700 border-b pb-2 mb-4">Demographics & Calculated BMI</h2>

      <div class="grid grid-cols-2 gap-4">
        <!-- Age Input -->
        <div class="input-group">
          <label for="input-age" class="block text-sm">Age (Years)</label>
          <div class="flex items-center mt-1 bg-gray-100 rounded-lg shadow-inner">
            <input
              type="number"
              id="input-age"
              min="0"
              max="150"
              step="1"
              placeholder="e.g. 35"
              class="input-field w-full bg-transparent"
              oninput="calculateScore()"
            />
            <span class="mr-3 text-gray-500 font-medium text-sm">yr</span>
          </div>
        </div>

        <!-- Weight Input -->
        <div class="input-group">
          <label for="input-weight" class="block text-sm">Weight (kg)</label>
          <div class="flex items-center mt-1 bg-gray-100 rounded-lg shadow-inner">
            <input
              type="number"
              id="input-weight"
              min="1"
              step="0.1"
              placeholder="e.g. 70.0"
              class="input-field w-full bg-transparent"
              oninput="calculateScore()"
            />
            <span class="mr-3 text-gray-500 font-medium text-sm">kg</span>
          </div>
        </div>
        
        <!-- Height Input -->
        <div class="input-group">
          <label for="input-height" class="block text-sm">Height (m)</label>
          <div class="flex items-center mt-1 bg-gray-100 rounded-lg shadow-inner">
            <input
              type="number"
              id="input-height"
              min="0.1"
              step="0.01"
              placeholder="e.g. 1.75"
              class="input-field w-full bg-transparent"
              oninput="calculateScore()"
            />
            <span class="mr-3 text-gray-500 font-medium text-sm">m</span>
          </div>
        </div>
      </div>

      <!-- Calculated BMI Display -->
      <div class="mt-4 p-4 rounded-xl text-center bg-indigo-50 border border-indigo-200 shadow-md">
          <p class="text-sm font-semibold text-indigo-600">Calculated BMI (kg/m²)</p>
          <p id="calculated-bmi" class="text-3xl font-extrabold text-indigo-800 mt-0">--</p>
          <p id="bmi-status" class="text-sm font-medium mt-1 text-gray-500 h-4"></p>
      </div>

      <!-- 2. Comorbidities -->
      <h2 class="text-lg font-bold text-indigo-700 border-b pb-2 pt-4 mb-4">2. Comorbidities (1 Point Each)</h2>
      <div id="comorbidity-toggles" class="space-y-3">
        <!-- Renal Failure (1 point) -->
        <div class="flex justify-between items-center p-3 bg-white border rounded-xl shadow-sm">
          <label class="text-sm font-medium text-gray-700">Renal Failure</label>
          <input type="checkbox" id="check-renal" class="hidden toggle-switch-input" onchange="handleToggleChange('renal')">
          <label for="check-renal" class="relative w-12 h-6 cursor-pointer rounded-full bg-gray-300 toggle-switch toggle-switch-label">
            <span class="absolute w-5 h-5 bg-white rounded-full shadow-md slider top-0.5 left-0.5"></span>
          </label>
        </div>
        <!-- Liver Failure (1 point) -->
        <div class="flex justify-between items-center p-3 bg-white border rounded-xl shadow-sm">
          <label class="text-sm font-medium text-gray-700">Liver Failure</label>
          <input type="checkbox" id="check-liver" class="hidden toggle-switch-input" onchange="handleToggleChange('liver')">
          <label for="check-liver" class="relative w-12 h-6 cursor-pointer rounded-full bg-gray-300 toggle-switch toggle-switch-label">
            <span class="absolute w-5 h-5 bg-white rounded-full shadow-md slider top-0.5 left-0.5"></span>
          </label>
        </div>
      </div>
      
      <!-- 3. Special Population (Consolidated) -->
      <h2 class="text-lg font-bold text-indigo-700 border-b pb-2 pt-4 mb-4">3. Special Population (1 Point Each)</h2>
      <div id="special-population-check" class="space-y-3">
        
        <!-- Children/Adolescent (<20 years) -->
        <div class="p-3 rounded-xl shadow-sm border border-gray-200 transition-colors duration-200" id="age-child-pop-box">
            <p class="text-sm font-medium text-gray-700">Children/Adolescent (&lt;20 years)</p>
            <p id="age-child-pop-status" class="text-xs font-bold mt-1 text-red-500">NOT MET</p>
        </div>

        <!-- Elderly (≥65 years) -->
        <div class="p-3 rounded-xl shadow-sm border border-gray-200 transition-colors duration-200" id="age-geriatric-pop-box">
            <p class="text-sm font-medium text-gray-700">Elderly (&ge;65 years)</p>
            <p id="age-geriatric-pop-status" class="text-xs font-bold mt-1 text-red-500">NOT MET</p>
        </div>

        <!-- Pregnancy Toggle -->
        <div class="flex justify-between items-center p-3 bg-white border rounded-xl shadow-sm">
          <label class="text-sm font-medium text-gray-700">Pregnant</label>
          <input type="checkbox" id="check-pregnancy" class="hidden toggle-switch-input" onchange="handleToggleChange('pregnancy')">
          <label for="check-pregnancy" class="relative w-12 h-6 cursor-pointer rounded-full bg-gray-300 toggle-switch toggle-switch-label">
            <span class="absolute w-5 h-5 bg-white rounded-full shadow-md slider top-0.5 left-0.5"></span>
          </label>
        </div>

        <!-- Less than 3 months post major surgery Toggle -->
        <div class="flex justify-between items-center p-3 bg-white border rounded-xl shadow-sm">
            <label class="text-sm font-medium text-gray-700">Less than 3 months post major surgery</label>
            <input type="checkbox" id="check-surgery" class="hidden toggle-switch-input" onchange="handleToggleChange('surgery')">
            <label for="check-surgery" class="relative w-12 h-6 cursor-pointer rounded-full bg-gray-300 toggle-switch toggle-switch-label">
                <span class="absolute w-5 h-5 bg-white rounded-full shadow-md slider top-0.5 left-0.5"></span>
            </label>
        </div>
      </div>


      <!-- 4. Clinical Factors -->
      <h2 class="text-lg font-bold text-indigo-700 border-b pb-2 pt-4 mb-4">4. Clinical Factors (1 Point Each)</h2>
      
      <div id="clinical-toggles" class="space-y-3">
        <!-- Toggles will be injected here by JS -->
      </div>
    </main>

    <!-- Score Summary (Sticky Footer) -->
    <footer id="score-footer" class="p-6 bg-gray-100 border-t-8 border-indigo-700">
      <div class="text-center">
        <p class="text-sm font-semibold text-gray-600">Total Positive Criteria</p>
        <div
          id="final-score"
          class="text-6xl font-extrabold text-indigo-700 mt-1"
        >
          0
        </div>
      </div>
      <div id="indication-box" class="mt-4 p-4 rounded-xl text-center shadow-lg transition-all duration-300">
        <p class="font-bold text-lg">TDM Indication Status</p>
        <p id="indication-text" class="text-xl font-extrabold mt-1">NO INDICATION</p>
      </div>
    </footer>
  </div>

  <script>
    // --- Data Definition for Toggles (Clinical Factors)
    const CRITERIA_TOGGLES = [
      { id: '2', text: 'Seizure occurs during sleep' },
      { id: '3', text: 'Any drug/dose changes (ASM only)' },
      { id: '4', text: 'Suspected subtherapeutic dose' },
      { id: '5', text: 'Suspected adverse effect or toxicity' },
      { id: '6a', text: 'Changes in medication (Brand / Formulation)' },
      { id: '7', text: 'Poor compliance suspected' },
      { id: '8', text: 'Any suspected interaction' },
    ];

    // --- DOM Elements ---
    const scoreEl = document.getElementById('final-score');
    const indicationBox = document.getElementById('indication-box');
    const indicationText = document.getElementById('indication-text');
    const clinicalTogglesEl = document.getElementById('clinical-toggles');
    const inputAge = document.getElementById('input-age');
    const inputWeight = document.getElementById('input-weight');
    const inputHeight = document.getElementById('input-height');
    const calculatedBmiEl = document.getElementById('calculated-bmi');
    const bmiStatusEl = document.getElementById('bmi-status');
    const ageChildPopStatusEl = document.getElementById('age-child-pop-status');
    const ageGeriatricPopStatusEl = document.getElementById('age-geriatric-pop-status');
    const ageChildPopBox = document.getElementById('age-child-pop-box');
    const ageGeriatricPopBox = document.getElementById('age-geriatric-pop-box');

    // --- Utility Functions ---
    // Scopes storage keys using the application ID
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const getStorageKey = (id) => `${appId}-calc-${id}`;
    const loadState = (id) => localStorage.getItem(getStorageKey(id));
    const saveState = (id, value) => localStorage.setItem(getStorageKey(id), value);

    // Calculates BMI (kg/m^2) and updates the display
    function getCalculatedBMI() {
        const weight = parseFloat(inputWeight.value);
        const height = parseFloat(inputHeight.value);
        let calculatedBMI = 0;
        
        if (weight > 0 && height > 0) {
            calculatedBMI = weight / (height * height);
            calculatedBmiEl.textContent = calculatedBMI.toFixed(1);
        } else {
            calculatedBmiEl.textContent = '--';
        }
        return calculatedBMI;
    }

    // Handles toggle state change for factors and saves to storage
    function handleToggleChange(id) {
        const checkbox = document.getElementById(`check-${id}`);
        // For static toggles (renal, liver, pregnancy, surgery), we rely on their element IDs
        if (checkbox) { 
            saveState(id, checkbox.checked);
        }
        calculateScore();
    }
    
    // Renders dynamic clinical factor toggles
    function renderToggles() {
      clinicalTogglesEl.innerHTML = '';
      CRITERIA_TOGGLES.forEach(item => {
        const key = item.id;
        
        // Restore state
        const isChecked = loadState(key) === 'true';

        const html = `
          <div class="flex justify-between items-center p-3 bg-white border rounded-xl shadow-sm toggle-group">
            <div class="flex-1 mr-4">
                <label for="check-${key}" class="text-sm font-medium text-gray-700">${item.text}</label>
            </div>
            <input type="checkbox" id="check-${key}" class="hidden toggle-switch-input" onchange="handleToggleChange('${key}')" ${isChecked ? 'checked' : ''}>
            <label for="check-${key}" class="relative w-12 h-6 cursor-pointer rounded-full bg-gray-300 toggle-switch toggle-switch-label">
              <span class="absolute w-5 h-5 bg-white rounded-full shadow-md slider top-0.5 left-0.5"></span>
            </label>
          </div>
        `;
        clinicalTogglesEl.insertAdjacentHTML('beforeend', html);
      });
      
      // Set up listeners for static condition toggles and restore state
      ['renal', 'liver', 'pregnancy', 'surgery'].forEach(id => {
          const el = document.getElementById(`check-${id}`);
          if (el) {
              el.checked = loadState(id) === 'true';
              // Listener is attached via onchange attribute in HTML, just need to restore state here
          }
      });
    }


    // --- Main Calculation Logic ---
    function calculateScore() {
      let score = 0;
      
      // Save input values to localStorage on every change
      saveState('age', inputAge.value);
      saveState('weight', inputWeight.value);
      saveState('height', inputHeight.value);


      // Calculate and get BMI
      const calculatedBMI = getCalculatedBMI();
      
      // --- 1. BMI-Related (1g: Obese, 1h: Low BMI) ---
      let bmiStatus = '';
      let bmiScore = 0; // Use a temporary variable for BMI score
      
      // Obese (BMI ≥ 27.5 kg/m²) - 1 point
      if (calculatedBMI >= 27.5) { 
          bmiScore = 1; 
          bmiStatus = 'Status: OBESE (Score +1)';
      } 
      // Low BMI (BMI ≤ 18.5 kg/m²) - 1 point
      else if (calculatedBMI > 0 && calculatedBMI <= 18.5) { 
          bmiScore = 1; 
          bmiStatus = 'Status: LOW BMI (Score +1)';
      } 
      else if (calculatedBMI > 0) {
          bmiStatus = 'Status: Normal/Overweight';
      }
      bmiStatusEl.textContent = bmiStatus;
      score += bmiScore; // Add 1 point max for BMI criteria

      // --- 2. Comorbidities (Renal/Liver) - 1 point each ---
      if (document.getElementById('check-renal')?.checked) score++;
      if (document.getElementById('check-liver')?.checked) score++;

      // --- 3. Special Population (Child, Geriatric, Pregnant, Post-Surgery) - MAX 1 point ---
      const age = parseFloat(inputAge.value);
      const isChild = age > 0 && age < 20;
      const isGeriatric = age >= 65;
      const isPregnant = document.getElementById('check-pregnancy')?.checked;
      const isPostSurgery = document.getElementById('check-surgery')?.checked;

      // Update Child Status Display
      if (isChild) {
          ageChildPopBox.classList.remove('border-gray-200');
          ageChildPopBox.classList.add('border-green-400', 'bg-green-50');
          ageChildPopStatusEl.classList.replace('text-red-500', 'text-green-600');
          ageChildPopStatusEl.textContent = 'MET';
      } else {
          ageChildPopBox.classList.add('border-gray-200');
          ageChildPopBox.classList.remove('border-green-400', 'bg-green-50');
          ageChildPopStatusEl.classList.replace('text-green-600', 'text-red-500');
          ageChildPopStatusEl.textContent = 'NOT MET';
      }
      
      // Update Geriatric Status Display
      if (isGeriatric) {
          ageGeriatricPopBox.classList.remove('border-gray-200');
          ageGeriatricPopBox.classList.add('border-green-400', 'bg-green-50');
          ageGeriatricPopStatusEl.classList.replace('text-red-500', 'text-green-600');
          ageGeriatricPopStatusEl.textContent = 'MET';
      } else {
          ageGeriatricPopBox.classList.add('border-gray-200');
          ageGeriatricPopBox.classList.remove('border-green-400', 'bg-green-50');
          ageGeriatricPopStatusEl.classList.replace('text-green-600', 'text-red-500');
          ageGeriatricPopStatusEl.textContent = 'NOT MET';
      }


      // Scoring: If ANY of the four conditions are met, score 1 point (Max 1).
      if (isChild || isGeriatric || isPregnant || isPostSurgery) {
          score++;
      }

      // --- 4. Clinical Factors (1 point each) ---
      CRITERIA_TOGGLES.forEach(item => {
        const checkbox = document.getElementById(`check-${item.id}`);
        if (checkbox && checkbox.checked) {
          score++;
        }
      });
      
      // Update Score Display
      scoreEl.textContent = score;

      // Update Indication Status
      if (score > 0) {
        // TDM Indication: YES
        indicationBox.classList.remove('bg-gray-100', 'text-gray-700');
        indicationBox.classList.add('bg-green-600', 'text-white');
        indicationText.textContent = 'TDM IS INDICATED';
      } else {
        // TDM Indication: NO
        indicationBox.classList.remove('bg-green-600', 'text-white');
        indicationBox.classList.add('bg-gray-100', 'text-gray-700');
        indicationText.textContent = 'NO INDICATION';
      }
    }

    // --- Initialization on Load ---
    window.onload = function() {
      // Render the clinical toggles
      renderToggles();
      
      // Restore Input state (and save new state when typing)
      const inputs = ['age', 'weight', 'height'];
      inputs.forEach(id => {
          const el = document.getElementById(`input-${id}`);
          const state = loadState(id);
          if (el && state) el.value = state;
          // Add listener to save immediately on input
          el?.addEventListener('input', () => saveState(id, el.value));
      });

      // Initial calculation with restored state
      calculateScore();
    };

    // Expose functions to the global scope for onchange/oninput events
    window.handleToggleChange = handleToggleChange;
    window.calculateScore = calculateScore;
  </script>
</body>
</html>


